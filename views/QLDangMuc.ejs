<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Lý Danh Mục - MobileStore Pro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <i class="fas fa-mobile-alt"></i>
                </div>
                <div class="sidebar-title">MobileStore Pro</div>
            </div>
            
            <div class="sidebar-menu">
                <div class="menu-section">
                    <div class="menu-section-title">Tổng quan</div>
                    
                    <a href="/TongQuanHeThong" class="menu-item  admin-only">
                        <div class="menu-icon">
                            <i class="fas fa-home"></i>
                        </div>
                        <div class="menu-text">Dashboard</div>
                    </a>
                </div>
        
                <div class="menu-section">
                    <div class="menu-section-title">Quản lý</div>
                    <a href="/QLSanPham" class="menu-item">
                        <div class="menu-icon">
                            <i class="fas fa-box"></i>
                        </div>
                        <div class="menu-text">Sản phẩm</div>
                    </a>
                    
                    <a href="/QLDonHang" class="menu-item">
                        <div class="menu-icon">
                            <i class="fas fa-shopping-cart"></i>
                        </div>
                        <div class="menu-text">Đơn hàng</div>
                    </a>
                    
                    <a href="/QLKhachHang" class="menu-item">
                        <div class="menu-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="menu-text">Khách hàng</div>
                    </a>
                    
                    <a href="/QLNhanVien" class="menu-item admin-only">
                        <div class="menu-icon">
                            <i class="fas fa-user-tie"></i>
                        </div>
                        <div class="menu-text">Nhân viên</div>
                    </a>
                </div>
        
                <div class="menu-section">
                    <div class="menu-section-title">Hệ thống</div>
                    
                    <a href="/QLNhaCungCap" class="menu-item admin-only">
                        <div class="menu-icon">
                            <i class="fas fa-truck"></i>
                        </div>
                        <div class="menu-text">Nhà cung cấp</div>
                    </a>
                    
                    <a href="/QLDangMuc" class="menu-item admin-only">
                        <div class="menu-icon">
                            <i class="fas fa-list"></i>
                        </div>
                        <div class="menu-text">Danh mục</div>
                    </a>
                    
                    <a href="reports.html" class="menu-item admin-only">
                        <div class="menu-icon">
                            <i class="fas fa-chart-bar"></i>
                        </div>
                        <div class="menu-text">Báo cáo</div>
                    </a>
                    
                    <a href="settings.html" class="menu-item admin-only">
                        <div class="menu-icon">
                            <i class="fas fa-cog"></i>
                        </div>
                        <div class="menu-text">Cài đặt</div> </a>
                </div>
            </div>
            
            <div class="sidebar-footer">
                <div class="admin-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="admin-info">
                    <div class="admin-name" id="current-username">User</div>
                    <div class="admin-role" id="current-role-name">Thành viên</div>
                </div>
                <div class="logout-btn" onclick="logout()" style="cursor: pointer; margin-left: 10px;">
                     <i class="fas fa-sign-out-alt"></i>
                </div>
            </div>
            
            <div class="toggle-sidebar">
                <i class="fas fa-chevron-left"></i>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Header -->
            <header class="header">
                <div class="header-left">
                    <div class="header-title">Quản Lý Danh Mục</div>
                    <div class="breadcrumb">
                        <div class="breadcrumb-item">
                            <i class="fas fa-home"></i>
                            <a href="index.html">Trang chủ</a>
                        </div>
                        <div class="breadcrumb-item active">Danh mục</div>
                    </div>
                </div>
                
                <div class="header-right">
                    <div class="search-box">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" id="categorySearch" placeholder="Tìm kiếm danh mục...">
                    </div>
                    
                    <div class="notifications">
                        <i class="fas fa-bell notification-icon"></i>
                        <span class="notification-count">3</span>
                        <div class="notification-dropdown">
                            <div class="notification-header">
                                <div class="notification-title">Thông báo</div>
                                <div class="notification-clear">Đánh dấu đã đọc tất cả</div>
                            </div>
                            <div class="notification-list">
                                <!-- Notifications will be loaded here -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="user-menu">
                        <div class="user-info">
                            <div class="admin-avatar">
                                <i class="fas fa-user"></i>
                            </div>
                            <div>
                                <div class="user-name">Nguyen Van An</div>
                                <div class="user-role">Quản lý</div>
                            </div>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="user-dropdown">
                            <div class="user-dropdown-item">
                                <i class="fas fa-user"></i>
                                <span>Hồ sơ cá nhân</span>
                            </div>
                            <div class="user-dropdown-item">
                                <i class="fas fa-cog"></i>
                                <span>Cài đặt tài khoản</span>
                            </div>
                            <div class="user-dropdown-divider"></div>
                            <div class="user-dropdown-item logout-btn">
                                <i class="fas fa-sign-out-alt"></i>
                                <span>Đăng xuất</span>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Content -->
            <div class="content">
                <!-- Page Header -->
                <div class="page-header">
                    <div>
                        <div class="page-title">Quản Lý Danh Mục Sản Phẩm</div>
                        <div class="page-subtitle">Quản lý và phân loại các danh mục sản phẩm điện thoại</div>
                    </div>
                    <div class="page-actions">
                        <button class="btn btn-outline" onclick="exportCategories()">
                            <i class="fas fa-file-export"></i> Xuất Excel
                        </button>
                        <button class="btn btn-primary" onclick="openModal('addCategoryModal')">
                            <i class="fas fa-folder-plus"></i> Thêm danh mục
                        </button>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #4361ee, #4cc9f0);">
                            <i class="fas fa-list"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="totalCategories">5</h3>
                            <p>Tổng danh mục</p>
                        </div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #7209b7, #f72585);">
                            <i class="fas fa-box"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="totalProducts">54</h3>
                            <p>Sản phẩm</p>
                        </div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #ff9e00, #ffd166);">
                            <i class="fas fa-money-bill-wave"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="totalRevenue">3.84 tỷ</h3>
                            <p>Doanh thu</p>
                        </div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #06d6a0, #118ab2);">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="avgRevenue">768 tr</h3>
                            <p>Doanh thu/DM</p>
                        </div>
                    </div>
                </div>

                <!-- Categories Table -->
                <div class="table-container">
                    <div class="table-header">
                        <div class="table-title">Danh sách danh mục</div>
                        <div class="table-actions">
                            <div class="table-filters">
                                
                                <select class="filter-select" id="sortFilter">
                                    <option value="sort">Sắp xếp</option>
                                    <option value="name">Sắp xếp theo tên</option>
                                    <option value="products">Sản phẩm nhiều nhất</option>
                                    <option value="revenue">Doanh thu cao nhất</option>
                                </select>
                            </div>
                            <button class="btn btn-outline btn-sm" onclick="resetFilters()">
                                <i class="fas fa-redo"></i> Đặt lại
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table id="categoriesTable">
                            <thead>
                                <tr>
                                    <th>Mã DM</th>
                                    <th>Tên danh mục</th>
                                    <th>Số sản phẩm</th>
                                    <th>Doanh thu</th>
                                    <th>Tỷ lệ</th>
                                    
                                    <th>Thao tác</th>
                                </tr>
                            </thead>
                            <tbody>
                                
                            </tbody>
                        </table>
                        
                    </div>
                </div>

                <!-- Revenue Chart -->
                <div class="widgets-container">
                    <div class="widget">
                        <div class="widget-header">
                            <div class="widget-title">Doanh thu theo danh mục</div>
                            <select class="filter-select" id="chartFilter">
                                <option value="revenue">Doanh thu</option>
                                <option value="products">Số sản phẩm</option>
                            </select>
                        </div>
                        <div class="widget-content">
                            <div class="chart-placeholder" id="revenueChart">
                                <!-- Chart will be rendered here -->
                                <canvas id="categoryChart" height="250"></canvas>
                            </div>
                        </div>
                    </div>
                    
                   
                </div>

                <!-- Category Products -->
                <div class="table-container">
                    <div class="table-header">
                        <div class="table-title">Sản phẩm theo danh mục</div>
                        <div class="table-actions">
                            <select class="filter-select" id="productCategoryFilter">
                                <option value="">Chọn danh mục</option>
                                <option value="DM001">iPhone</option>
                                <option value="DM002">Samsung</option>
                                <option value="DM003">Xiaomi</option>
                                <option value="DM004">Oppo</option>
                                <option value="DM005">Vivo</option>
                            </select>
                            <!-- <button class="btn btn-outline" onclick="refreshProducts()">
                                <i class="fas fa-sync"></i> Làm mới
                            </button> -->
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table id="categoryProductsTable">
                            <thead>
                                <tr>
                                    <th>Mã SP</th>
                                    <th>Tên sản phẩm</th>
                                    <th>Giá bán</th>
                                    <th>Tồn kho</th>
                                    <th>Đã bán</th>
                                    <th>Doanh thu</th>
                                    <th>Nhà cung cấp</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Products will be loaded here based on category selection -->
                                <tr id="noProductsMessage">
                                    <td colspan="7" style="text-align: center; padding: 40px;">
                                        <i class="fas fa-info-circle" style="font-size: 40px; color: #6c757d; margin-bottom: 10px;"></i>
                                        <h3 style="color: #6c757d; margin-bottom: 10px;">Chọn danh mục để xem sản phẩm</h3>
                                        <p style="color: #adb5bd;">Vui lòng chọn một danh mục từ danh sách trên để xem các sản phẩm thuộc danh mục đó</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <footer class="footer">
                <div>
                    &copy; 2024 MobileStore Pro. Phiên bản 2.0.0
                </div>
                <div class="footer-links">
                    <a href="#" class="footer-link">Trợ giúp</a>
                    <a href="#" class="footer-link">Điều khoản</a>
                    <a href="#" class="footer-link">Bảo mật</a>
                </div>
            </footer>
        </div>
    </div>

    <!-- Modal: Thêm danh mục -->
    <div class="modal" id="addCategoryModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Thêm danh mục mới</div>
                <button class="close-modal" onclick="closeModal('addCategoryModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addCategoryForm">
                    <div class="form-section">
                        <div class="form-section-title">
                            <i class="fas fa-folder"></i> Thông tin danh mục
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Mã danh mục (MaDM)</label>
                                
                                <input type="text" class="form-control" id="addMaDM" name="MaDM"
                                    placeholder="Để trống để tự động sinh mã (VD: DM006)" 
                                    pattern="[A-Z0-9]+" maxlength="20"
                                    title="Chỉ chấp nhận chữ in hoa và số">
                                    
                                <small class="form-text text-muted">Có thể để trống. Nếu nhập: chỉ dùng chữ in hoa và số.</small>
                            </div>
                            <div class="form-group">
                                <label class="form-label required">Tên danh mục</label>
                                <input type="text" class="form-control" name="TenDanhMuc" required 
                                       placeholder="Nhập tên danh mục">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Mô tả</label>
                            <textarea class="form-control" name="MoTa" rows="3" 
                                      placeholder="Mô tả về danh mục này..."></textarea>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Trạng thái</label>
                                <select class="form-control form-select" name="TrangThai">
                                    <option value="active" selected>Hoạt động</option>
                                    <option value="inactive">Ngừng hoạt động</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Icon</label>
                                <select class="form-control form-select" name="Icon">
                                    <option value="mobile-alt">Điện thoại</option>
                                    <option value="mobile">Smartphone</option>
                                    <option value="tablet">Máy tính bảng</option>
                                    <option value="headphones">Phụ kiện</option>
                                    <option value="battery-full">Pin & Sạc</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-primary" onclick="saveCategory()">
                            <i class="fas fa-save"></i> Lưu danh mục
                        </button>
                        <button type="button" class="btn btn-outline" onclick="closeModal('addCategoryModal')">Hủy</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal: Sửa danh mục -->
    <div class="modal" id="editCategoryModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Chỉnh sửa danh mục</div>
                <button class="close-modal" onclick="closeModal('editCategoryModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editCategoryForm">
                    <input type="hidden" name="MaDM" id="editMaDM">
                    
                    <div class="form-section">
                        <div class="form-section-title">
                            <i class="fas fa-folder"></i> Thông tin danh mục
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Mã danh mục</label>
                                <input type="text" class="form-control" id="displayMaDM" readonly disabled>
                            </div>
                            <div class="form-group">
                                <label class="form-label required">Tên danh mục</label>
                                <input type="text" class="form-control" name="TenDanhMuc" required 
                                       placeholder="Nhập tên danh mục">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Mô tả</label>
                            <textarea class="form-control" name="MoTa" rows="3" 
                                      placeholder="Mô tả về danh mục này..."></textarea>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Trạng thái</label>
                                <select class="form-control form-select" name="TrangThai">
                                    <option value="active">Hoạt động</option>
                                    <option value="inactive">Ngừng hoạt động</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Icon</label>
                                <select class="form-control form-select" name="Icon">
                                    <option value="mobile-alt">Điện thoại</option>
                                    <option value="mobile">Smartphone</option>
                                    <option value="tablet">Máy tính bảng</option>
                                    <option value="headphones">Phụ kiện</option>
                                    <option value="battery-full">Pin & Sạc</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-primary" onclick="updateCategory()">
                            <i class="fas fa-save"></i> Cập nhật
                        </button>
                        <button type="button" class="btn btn-outline" onclick="closeModal('editCategoryModal')">Hủy</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal: Xem chi tiết danh mục -->
    <div class="modal" id="viewCategoryModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <div class="modal-title">Chi tiết danh mục</div>
                <button class="close-modal" onclick="closeModal('viewCategoryModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="categoryDetailContent">
                    <!-- Category details will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="editCurrentCategory()">
                    <i class="fas fa-edit"></i> Chỉnh sửa
                </button>
                <button type="button" class="btn btn-outline" onclick="closeModal('viewCategoryModal')">Đóng</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/script.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <script src="js/QLDanhMuc.js"></script>
    <script>
        // Hàm đăng xuất
        function logout() {
            localStorage.clear(); // Xóa sạch token và info
            window.location.href = "/login";
        }
    
        document.addEventListener("DOMContentLoaded", function() {
            // 1. Lấy thông tin từ LocalStorage
            const role = localStorage.getItem("userRole");
            const username = localStorage.getItem("username");
    
            // 2. Hiển thị tên người dùng vào Sidebar
            if (username) {
                document.getElementById("current-username").innerText = username;
            }
    
            // 3. Xử lý phân quyền hiển thị (Ẩn menu nếu không phải Admin)
            // Lưu ý: role 1 là Admin (theo file roles.js của bạn)
            if (role != "1") {
                // Đổi chức vụ hiển thị
                document.getElementById("current-role-name").innerText = "Nhân viên";
    
                // Tìm và ẩn các mục có class 'admin-only'
                const adminElements = document.querySelectorAll('.admin-only');
                adminElements.forEach(function(el) {
                    el.style.display = 'none';
                });
                
                // Chặn truy cập trang Dashboard nếu lỡ vào
                if (window.location.pathname.includes("TongQuanHeThong")) {
                     window.location.href = "/QLDonHang";
                }
            } else {
                 document.getElementById("current-role-name").innerText = "Quản trị viên";
            }
        });
    </script>
</body>
</html>
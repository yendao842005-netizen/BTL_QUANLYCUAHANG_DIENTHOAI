<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quản Lý Khách Hàng - MobileStore Pro</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="css/styles.css" />
  </head>
  <body>
    <div class="app-container">
      <!-- Sidebar -->
      <div class="sidebar">
        <div class="sidebar-header">
          <div class="sidebar-logo">
            <i class="fas fa-mobile-alt"></i>
          </div>
          <div class="sidebar-title">MobileStore Pro</div>
        </div>

        <div class="sidebar-menu">
          <div class="menu-section">
            <div class="menu-section-title">Tổng quan</div>

            <a href="/TongQuanHeThong" class="menu-item admin-only">
              <div class="menu-icon">
                <i class="fas fa-home"></i>
              </div>
              <div class="menu-text">Dashboard</div>
            </a>
          </div>

          <div class="menu-section">
            <div class="menu-section-title">Quản lý</div>
            <a href="/QLSanPham" class="menu-item">
              <div class="menu-icon">
                <i class="fas fa-box"></i>
              </div>
              <div class="menu-text">Sản phẩm</div>
            </a>

            <a href="/QLDonHang" class="menu-item">
              <div class="menu-icon">
                <i class="fas fa-shopping-cart"></i>
              </div>
              <div class="menu-text">Đơn hàng</div>
            </a>

            <a href="/QLKhachHang" class="menu-item">
              <div class="menu-icon">
                <i class="fas fa-users"></i>
              </div>
              <div class="menu-text">Khách hàng</div>
            </a>

            <a href="/QLNhanVien" class="menu-item admin-only">
              <div class="menu-icon">
                <i class="fas fa-user-tie"></i>
              </div>
              <div class="menu-text">Nhân viên</div>
            </a>
          </div>

          <div class="menu-section">
            <div class="menu-section-title">Hệ thống</div>

            <a href="/QLNhaCungCap" class="menu-item admin-only">
              <div class="menu-icon">
                <i class="fas fa-truck"></i>
              </div>
              <div class="menu-text">Nhà cung cấp</div>
            </a>

            <a href="/QLDangMuc" class="menu-item admin-only">
              <div class="menu-icon">
                <i class="fas fa-list"></i>
              </div>
              <div class="menu-text">Danh mục</div>
            </a>

            <a href="reports.html" class="menu-item admin-only">
              <div class="menu-icon">
                <i class="fas fa-chart-bar"></i>
              </div>
              <div class="menu-text">Báo cáo</div>
            </a>

            <a href="settings.html" class="menu-item admin-only">
              <div class="menu-icon">
                <i class="fas fa-cog"></i>
              </div>
              <div class="menu-text">Cài đặt</div>
            </a>
          </div>
        </div>

        <div class="sidebar-footer">
          <div class="admin-avatar">
            <i class="fas fa-user"></i>
          </div>
          <div class="admin-info">
            <div class="admin-name" id="current-username">User</div>
            <div class="admin-role" id="current-role-name">Thành viên</div>
          </div>
          <div class="logout-btn" style="cursor: pointer; margin-left: 10px">
            <i class="fas fa-sign-out-alt"></i>
          </div>
        </div>

        <div class="toggle-sidebar">
          <i class="fas fa-chevron-left"></i>
        </div>
      </div>

      <!-- Main Content -->
      <div class="main-content">
        <!-- Header -->
        <header class="header">
          <div class="header-left">
            <div class="header-title">Quản Lý Khách Hàng</div>
            <div class="breadcrumb">
              <div class="breadcrumb-item">
                <i class="fas fa-home"></i>
                <a href="index.html">Trang chủ</a>
              </div>
              <div class="breadcrumb-item active">Khách hàng</div>
            </div>
          </div>

          <div class="header-right">
            <div class="search-box">
              <i class="fas fa-search search-icon"></i>
              <input
                type="text"
                id="customerSearch"
                placeholder="Tìm kiếm khách hàng..."
              />
            </div>

            <div class="notifications">
              <i class="fas fa-bell notification-icon"></i>
              <span class="notification-count">3</span>
              <div class="notification-dropdown">
                <div class="notification-header">
                  <div class="notification-title">Thông báo</div>
                  <div class="notification-clear">Đánh dấu đã đọc tất cả</div>
                </div>
                <div class="notification-list">
                  <!-- Notifications will be loaded here -->
                </div>
              </div>
            </div>

            <div class="user-menu">
              <div class="user-info">
                <div class="admin-avatar">
                  <i class="fas fa-user"></i>
                </div>
                <div>
                  <div class="user-name">Nguyen Van An</div>
                  <div class="user-role">Quản lý</div>
                </div>
                <i class="fas fa-chevron-down"></i>
              </div>
              <div class="user-dropdown">
                <div class="user-dropdown-item">
                  <i class="fas fa-user"></i>
                  <span>Hồ sơ cá nhân</span>
                </div>
                <div class="user-dropdown-item">
                  <i class="fas fa-cog"></i>
                  <span>Cài đặt tài khoản</span>
                </div>
                <div class="user-dropdown-divider"></div>
                <div class="user-dropdown-item logout-btn">
                  <i class="fas fa-sign-out-alt"></i>
                  <span>Đăng xuất</span>
                </div>
              </div>
            </div>
          </div>
        </header>

        <!-- Content -->
        <div class="content">
          <!-- Page Header -->
          <div class="page-header">
            <div>
              <div class="page-title">Quản Lý Khách Hàng</div>
              <div class="page-subtitle">
                Quản lý thông tin khách hàng và lịch sử mua hàng
              </div>
            </div>
            <div class="page-actions">
              <button class="btn btn-outline" id="btnExport">
                <i class="fas fa-file-export"></i> Xuất Excel
              </button>
              <button class="btn btn-primary" id="btnOpenAddModal">
                <i class="fas fa-user-plus"></i> Thêm khách hàng
              </button>
            </div>
          </div>

          <!-- Stats Cards -->
          <div class="stats-grid">
            <div class="stat-item">
              <div
                class="stat-icon"
                style="background: linear-gradient(135deg, #4361ee, #4cc9f0)"
              >
                <i class="fas fa-users"></i>
              </div>
              <div class="stat-info">
                <h3 id="statTotalCustomers">8</h3>
                <p>Tổng khách hàng</p>
              </div>
            </div>
            <div class="stat-item">
              <div
                class="stat-icon"
                style="background: linear-gradient(135deg, #7209b7, #f72585)"
              >
                <i class="fas fa-crown"></i>
              </div>
              <div class="stat-info">
                <h3 id="statVIPCustomers">2</h3>
                <p>Khách hàng VIP</p>
              </div>
            </div>
            <div class="stat-item">
              <div
                class="stat-icon"
                style="background: linear-gradient(135deg, #ff9e00, #ffd166)"
              >
                <i class="fas fa-user-plus"></i>
              </div>
              <div class="stat-info">
                <h3 id="statNewCustomers">2</h3>
                <p>Khách hàng mới</p>
              </div>
            </div>
            <div class="stat-item">
              <div
                class="stat-icon"
                style="background: linear-gradient(135deg, #06d6a0, #118ab2)"
              >
                <i class="fas fa-shopping-cart"></i>
              </div>
              <div class="stat-info">
                <h3 id="statTotalRevenue">785 triệu</h3>
                <p>Doanh thu từ KH</p>
              </div>
            </div>
          </div>

          <!-- Customers Table -->
          <div class="table-container">
            <div class="table-header">
              <div class="table-title">Danh sách khách hàng</div>
              <div class="table-actions">
                <div class="table-filters">
                  <select class="filter-select" id="customerTypeFilter">
                    <option value="">Tất cả loại KH</option>
                    <option value="vip">VIP</option>
                    <option value="regular">Thường</option>
                    <option value="new">Mới</option>
                  </select>

                </div>
                <button class="btn btn-outline btn-sm" id="btnResetFilters">
                  <i class="fas fa-redo"></i> Đặt lại
                </button>
              </div>
            </div>

            <div class="table-responsive">
              <table id="customersTable">
                <thead>
                  <tr>
                    <th>Mã KH</th>
                    <th>Họ tên</th>
                    <th>Số điện thoại</th>
                    <th>Email</th>
                    <th>Loại KH</th>
                    <th>Tổng đơn</th>
                    <th>Tổng chi tiêu</th>
                    <th>Thao tác</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
              <div class="pagination-container" id="pagination"></div>
            </div>
          </div>

          <div class="table-container">
            <div class="table-header">
              <div class="table-title">Khách hàng giá trị cao nhất</div>
              <div class="table-actions">
                <select class="filter-select" id="clvPeriod">
                  <option value="month">Tháng này</option>
                  <option value="quarter">Quý này</option>
                  <option value="year">Năm nay</option>
                </select>
              </div>
            </div>

            <div class="table-responsive">
              <table>
                <thead>
                  <tr>
                    <th>STT</th>
                    <th>Khách hàng</th>
                    <th>Số đơn hàng</th>
                    <th>Giá trị đơn TB</th>
                    <th>Tần suất mua</th>
                    <th>Lifetime Value</th>
                  </tr>
                </thead>
                <tbody id="clvTableBody">
                  
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Footer -->
        <footer class="footer">
          <div>&copy; 2024 MobileStore Pro. Phiên bản 2.0.0</div>
          <div class="footer-links">
            <a href="#" class="footer-link">Trợ giúp</a>
            <a href="#" class="footer-link">Điều khoản</a>
            <a href="#" class="footer-link">Bảo mật</a>
          </div>
        </footer>
      </div>
    </div>

    <!-- Modal: Thêm khách hàng -->
    <div class="modal" id="addCustomerModal">
      <div class="modal-content">
        <div class="modal-header">
          <div class="modal-title">Thêm khách hàng mới</div>
          <button class="close-modal">&times;</button>
        </div>
        <div class="modal-body">
          <form id="addCustomerForm">
            <div class="form-section">
              <div class="form-section-title">
                <i class="fas fa-id-card"></i> Thông tin cá nhân
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label ">Mã khách hàng</label>
                  <input
                      type="text"
                      class="form-control"
                      id="addMaKH"
                      name="MaKH"
                      placeholder="Để trống để tự động sinh mã (VD: KH009)"
                      pattern="[A-Z0-9]+"
                      maxlength="20"
                  />
                  
                  <small class="form-text text-muted">
                      Có thể để trống. Nếu nhập: chỉ dùng chữ in hoa và số
                  </small>
                </div>
                <div class="form-group">
                  <label class="form-label required">Họ và tên</label>
                  <input
                    type="text"
                    class="form-control"
                    name="HoTen"
                    required
                    placeholder="Nhập họ và tên"
                  />
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label class="form-label required">Số điện thoại</label>
                  <input
                    type="tel"
                    class="form-control"
                    name="SoDienThoai"
                    required
                    placeholder="Nhập số điện thoại"
                  />
                </div>
                <div class="form-group">
                  <label class="form-label">Email</label>
                  <input
                    type="email"
                    class="form-control"
                    name="Email"
                    placeholder="Nhập email"
                  />
                </div>
              </div>

              <div class="form-group">
                <label class="form-label">Địa chỉ</label>
                <textarea
                  class="form-control"
                  name="DiaChi"
                  rows="2"
                  placeholder="Nhập địa chỉ"
                ></textarea>
              </div>
            </div>

            <div class="form-section">
              <div class="form-section-title">
                <i class="fas fa-chart-line"></i> Thông tin phân loại
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Loại khách hàng</label>
                  <select class="form-control form-select" name="LoaiKH">
                    <option value="regular">Thường</option>
                    <option value="vip">VIP</option>
                    <option value="new">Mới</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label">Nguồn khách hàng</label>
                  <select class="form-control form-select" name="NguonKH">
                    <option value="walkin">Trực tiếp</option>
                    <option value="website">Website</option>
                    <option value="facebook">Facebook</option>
                    <option value="referral">Giới thiệu</option>
                  </select>
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Ngày sinh</label>
                  <input type="date" class="form-control" name="NgaySinh" />
                </div>
                <div class="form-group">
                  <label class="form-label">Giới tính</label>
                  <select class="form-control form-select" name="GioiTinh">
                    <option value="">Chọn giới tính</option>
                    <option value="Nam">Nam</option>
                    <option value="Nu">Nu</option>
                    <option value="Khac">Khac</option>
                  </select>
                </div>
              </div>
            </div>

            <div class="form-section">
              <div class="form-section-title">
                <i class="fas fa-cog"></i> Tùy chọn khác
              </div>
              <div class="form-group">
                <label class="form-label">Ghi chú</label>
                <textarea
                  class="form-control"
                  name="GhiChu"
                  rows="3"
                  placeholder="Ghi chú về khách hàng..."
                ></textarea>
              </div>
            </div>

            <div class="form-actions">
              <button
                type="button"
                class="btn btn-primary"
                id="btnSaveCustomer"
              >
                <i class="fas fa-save"></i> Lưu khách hàng
              </button>
              <button type="button" class="btn btn-outline btn-close-modal">
                Hủy
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Modal: Sửa khách hàng -->
    <div class="modal" id="editCustomerModal">
      <div class="modal-content">
        <div class="modal-header">
          <div class="modal-title">Chỉnh sửa khách hàng</div>
          <button class="close-modal">&times;</button>
        </div>
        <div class="modal-body">
          <form id="editCustomerForm">
            <input type="hidden" name="MaKH" id="editMaKH" />

            <div class="form-section">
              <div class="form-section-title">
                <i class="fas fa-id-card"></i> Thông tin cá nhân
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Mã khách hàng</label>
                  <input
                    type="text"
                    class="form-control"
                    id="displayMaKH"
                    readonly
                    disabled
                  />
                </div>
                <div class="form-group">
                  <label class="form-label required">Họ và tên</label>
                  <input
                    type="text"
                    class="form-control"
                    name="HoTen"
                    required
                    placeholder="Nhập họ và tên"
                  />
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label class="form-label required">Số điện thoại</label>
                  <input
                    type="tel"
                    class="form-control"
                    name="SoDienThoai"
                    required
                    placeholder="Nhập số điện thoại"
                  />
                </div>
                <div class="form-group">
                  <label class="form-label">Email</label>
                  <input
                    type="email"
                    class="form-control"
                    name="Email"
                    placeholder="Nhập email"
                  />
                </div>
              </div>

              <div class="form-group">
                <label class="form-label">Địa chỉ</label>
                <textarea
                  class="form-control"
                  name="DiaChi"
                  rows="2"
                  placeholder="Nhập địa chỉ"
                ></textarea>
              </div>
            </div>

            <div class="form-section">
              <div class="form-section-title">
                <i class="fas fa-chart-line"></i> Thông tin phân loại
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Loại khách hàng</label>
                  <select class="form-control form-select" name="LoaiKH">
                    <option value="regular">Thường</option>
                    <option value="vip">VIP</option>
                    <option value="new">Mới</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label">Nguồn khách hàng</label>
                  <select class="form-control form-select" name="NguonKH">
                    <option value="walkin">Trực tiếp</option>
                    <option value="website">Website</option>
                    <option value="facebook">Facebook</option>
                    <option value="referral">Giới thiệu</option>
                  </select>
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Ngày sinh</label>
                  <input type="date" class="form-control" name="NgaySinh" />
                </div>
                <div class="form-group">
                  <label class="form-label">Giới tính</label>
                  <select class="form-control form-select" name="GioiTinh">
                    <option value="">Chọn giới tính</option>
                    <option value="Nam">Nam</option>
                    <option value="Nu">Nữ</option>
                    <option value="Khac">Khác</option>
                  </select>
                </div>
              </div>
            </div>

            <div class="form-section">
              <div class="form-section-title">
                <i class="fas fa-cog"></i> Tùy chọn khác
              </div>
              <div class="form-group">
                <label class="form-label">Ghi chú</label>
                <textarea
                  class="form-control"
                  name="GhiChu"
                  rows="3"
                  placeholder="Ghi chú về khách hàng..."
                ></textarea>
              </div>
            </div>

            <div class="form-actions">
              <button
                type="button"
                class="btn btn-primary"
                id="btnUpdateCustomer"
              >
                <i class="fas fa-save"></i> Cập nhật
              </button>
              <button type="button" class="btn btn-outline btn-close-modal">
                Hủy
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Modal: Xem chi tiết khách hàng -->
    <div class="modal" id="viewCustomerModal">
      <div class="modal-content" style="max-width: 700px">
        <div class="modal-header">
          <div class="modal-title">Chi tiết khách hàng</div>
          <button class="close-modal">&times;</button>
        </div>
        <div class="modal-body">
          <div id="customerDetailContent">
            <!-- Customer details will be loaded here -->
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-primary"
            id="btnEditCurrentCustomer"
          >
            <i class="fas fa-edit"></i> Chỉnh sửa
          </button>
          <button type="button" class="btn btn-secondary btn-close-modal">
            Đóng
          </button>
        </div>
      </div>
    </div>

    <!-- Modal: Phân khúc khách hàng -->
    <div class="modal" id="segmentCustomersModal">
      <div class="modal-content" style="max-width: 600px">
        <div class="modal-header">
          <div class="modal-title">Tạo phân khúc khách hàng</div>
          <button class="close-modal">&times;</button>
        </div>
        <div class="modal-body">
          <form id="segmentForm">
            <div class="form-group">
              <label class="form-label required">Tên phân khúc</label>
              <input
                type="text"
                class="form-control"
                name="segmentName"
                required
                placeholder="VD: Khách hàng VIP mua iPhone"
              />
            </div>

            <div class="form-group">
              <label class="form-label">Tiêu chí phân khúc</label>
              <div class="segment-criteria">
                <div class="criterion">
                  <select class="form-control" name="criteriaField">
                    <option value="totalSpent">Tổng chi tiêu</option>
                    <option value="orderCount">Số lượng đơn hàng</option>
                    <option value="customerType">Loại khách hàng</option>
                  </select>
                  <select class="form-control" name="criteriaOperator">
                    <option value=">">Lớn hơn</option>
                    <option value="<">Nhỏ hơn</option>
                    <option value="=">Bằng</option>
                  </select>
                  <input
                    type="text"
                    class="form-control"
                    name="criteriaValue"
                    placeholder="Giá trị"
                  />
                </div>
              </div>

              <button
                type="button"
                class="btn btn-sm btn-outline"
                id="btnAddCriterion"
              >
                <i class="fas fa-plus"></i> Thêm tiêu chí
              </button>
            </div>

            <div class="form-group">
              <label class="form-label">Mô tả phân khúc</label>
              <textarea
                class="form-control"
                name="segmentDescription"
                rows="3"
                placeholder="Mô tả về phân khúc này..."
              ></textarea>
            </div>

            <div class="preview-section">
              <h6>
                Xem trước kết quả: <span id="previewCount">0</span> khách hàng
              </h6>
              <button
                type="button"
                class="btn btn-sm btn-outline"
                id="btnPreviewSegment"
              >
                <i class="fas fa-eye"></i> Xem trước
              </button>
            </div>

            <div class="form-actions">
              <button
                type="button"
                class="btn btn-primary"
                id="btnCreateSegment"
              >
                <i class="fas fa-save"></i> Tạo phân khúc
              </button>
              <button type="button" class="btn btn-outline btn-close-modal">
                Hủy
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="js/script.js"></script>

    <script src="js/QLKhachHang.js"></script>
    <script>
      // Hàm đăng xuất
      function logout() {
        localStorage.clear(); // Xóa sạch token và info
        window.location.href = "/login";
      }

      document.addEventListener("DOMContentLoaded", function () {
        // 1. Lấy thông tin từ LocalStorage
        const role = localStorage.getItem("userRole");
        const username = localStorage.getItem("username");

        // 2. Hiển thị tên người dùng vào Sidebar
        if (username) {
          document.getElementById("current-username").innerText = username;
        }

        // 3. Xử lý phân quyền hiển thị (Ẩn menu nếu không phải Admin)
        // Lưu ý: role 1 là Admin (theo file roles.js của bạn)
        if (role != "1") {
          // Đổi chức vụ hiển thị
          document.getElementById("current-role-name").innerText = "Nhân viên";

          // Tìm và ẩn các mục có class 'admin-only'
          const adminElements = document.querySelectorAll(".admin-only");
          adminElements.forEach(function (el) {
            el.style.display = "none";
          });

          // Chặn truy cập trang Dashboard nếu lỡ vào
          if (window.location.pathname.includes("TongQuanHeThong")) {
            window.location.href = "/QLDonHang";
          }
        } else {
          document.getElementById("current-role-name").innerText =
            "Quản trị viên";
        }
      });
    </script>
  </body>
</html>
